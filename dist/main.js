!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${t=e,s=this.boardSize,["top-left",...Array(s-2).fill("top"),"top-right",...Array(s-2).fill(["left",...Array(s-2).fill("center"),"right"]),"bottom-left",...Array(s-2).fill("bottom"),"bottom-right"].flat()[t]}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const h=document.createElement("div");h.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),h.style.width=`${s.character.health}%`,i.appendChild(h),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var t={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class s{constructor(){this.members=new Set}add(e){if(this.members.has(e))throw new Error("–¢–∞–∫–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂ —É–∂–µ e—Å—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ");this.members.add(e)}addAll(e){this.members=new Set([...this.members,...e])}delete(e){this.members.delete(e)}toArray(){return[...this.members]}*[Symbol.iterator](){for(const e of this.members)yield e}}function a(e,t,s){const a=[],i=function*(e,t){for(;;){const s=Math.floor(Math.random()*e.length),a=Math.floor(Math.random()*t)+1;yield new e[s](a)}}(e,t);for(;a.length<s;)a.push(i.next().value);return a}class i{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("It is forbidden to create objects of the Character class")}levelUp(){const e=this.health;this.level+=1,this.health+=80,this.health>100&&(this.health=100),this.attack=Math.max(this.attack,this.attack*((1.8-e)/100)),this.defence=Math.max(this.defence,this.defence*((1.8-e)/100))}}class h extends i{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"bowman"),this.attack=25,this.defence=25,this.distance=2,this.attackRange=2}}class r extends i{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"swordsman"),this.attack=40,this.defence=10,this.distance=4,this.attackRange=1}}class l extends i{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"daemon"),this.attack=10,this.defence=40,this.distance=1,this.attackRange=4}}class n extends i{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"undead"),this.attack=40,this.defence=10,this.distance=4,this.attackRange=1}}class o extends i{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"vampire"),this.attack=25,this.defence=25,this.distance=2,this.attackRange=2}}class c extends i{constructor(e){super(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:"magician"),this.attack=10,this.defence=40,this.distance=1,this.attackRange=4}}class d{constructor(e,t){if(!(e instanceof i))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class m{constructor(){this.isUsersTurn=!0,this.level=1,this.allPositions=[],this.points=0,this.statistics=[],this.selected=null}static from(e){return"object"==typeof e?e:null}}var g="auto",u="pointer",S="crosshair",f="not-allowed";const v=new e;v.bindToDOM(document.querySelector("#game-container"));const C=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),p=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.userTeam=new s,this.botTeam=new s,this.botCharacters=[l,n,o],this.userCharacters=[h,r,c],this.gameState=new m}init(){this.gamePlay.drawUi(t[this.gameState.level]),this.userTeam.addAll(a([h,r],1,2)),this.botTeam.addAll(a(this.botCharacters,1,2)),this.addsTheTeamToPosition(this.userTeam,this.getUserStartPositions()),this.addsTheTeamToPosition(this.botTeam,this.getBotStartPositions()),this.gamePlay.redrawPositions(this.gameState.allPositions),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGameClick.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGameClick.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGameClick.bind(this)),e.showMessage(`–£—Ä–æ–≤–µ–Ω—å ${this.gameState.level}`)}onCellClick(t){5!==this.gameState.level&&0!==this.userTeam.members.size&&(null!==this.gameState.selected&&this.getChar(t)&&this.isBotChar(t)&&this.isAttack(t)&&this.getAttack(t,this.gameState.selected),null!==this.gameState.selected&&this.isMoving(t)&&!this.getChar(t)&&this.gameState.isUsersTurn&&this.getUsersTurn(t),null===this.gameState.selected||this.isMoving(t)||this.isAttack(t)||this.gameState.isUsersTurn&&!this.getChar(t)&&e.showError("–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ö–æ–¥"),this.getChar(t)&&(this.getChar(t)&&this.isBotChar(t)&&!this.isAttack(t)&&e.showError("–≠—Ç–æ –Ω–µ –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–∂"),this.getChar(t)&&this.isUserChar(t)&&(this.gamePlay.cells.forEach((e=>e.classList.remove("selected-green"))),this.gamePlay.cells.forEach((e=>e.classList.remove("selected-yellow"))),this.gamePlay.selectCell(t),this.gameState.selected=t)))}onCellEnter(e){if(this.getChar(e)&&this.isUserChar(e)&&this.gamePlay.setCursor(u),null!==this.gameState.selected&&!this.getChar(e)&&this.isMoving(e)&&(this.gamePlay.setCursor(u),this.gamePlay.selectCell(e,"green")),this.getChar(e)){const t=this.getChar(e).character,s=`üéñ${t.level}‚öî${t.attack}üõ°${t.defence}‚ù§${t.health}`;this.gamePlay.showCellTooltip(s,e)}null!==this.gameState.selected&&this.getChar(e)&&!this.isUserChar(e)&&this.isAttack(e)&&(this.gamePlay.setCursor(S),this.gamePlay.selectCell(e,"red")),null===this.gameState.selected||this.isAttack(e)||this.isMoving(e)||this.isUserChar(e)||this.gamePlay.setCursor(f)}onCellLeave(e){this.gamePlay.cells.forEach((e=>e.classList.remove("selected-red"))),this.gamePlay.cells.forEach((e=>e.classList.remove("selected-green"))),this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(g)}getAttack(e){if(this.gameState.isUsersTurn){const t=this.getChar(this.gameState.selected).character,s=this.getChar(e).character,a=Math.max(t.attack-s.defence,.1*t.attack);if(!t||!s)return;this.gamePlay.showDamage(e,a).then((()=>{s.health-=a,s.health<=0&&(this.getDeletion(e),this.botTeam.delete(s))})).then((()=>{this.gamePlay.redrawPositions(this.gameState.allPositions)})).then((()=>{this.getGameResult(),this.getBotsResponse()})),this.gameState.isUsersTurn=!1}}getUsersTurn(e){this.getSelectedChar().position=e,this.gamePlay.deselectCell(this.gameState.selected),this.gamePlay.redrawPositions(this.gameState.allPositions),this.gameState.selected=e,this.gameState.isUsersTurn=!1,this.getBotsResponse()}getBotsResponse(){if(this.gameState.isUsersTurn)return;const e=this.gameState.allPositions.filter((e=>e.character instanceof o||e.character instanceof l||e.character instanceof n)),t=this.gameState.allPositions.filter((e=>e.character instanceof h||e.character instanceof r||e.character instanceof c));let s=null,a=null;if(0!==e.length&&0!==t.length)if(e.forEach((e=>{const i=this.calcRange(e.position,e.character.attackRange);t.forEach((t=>{i.includes(t.position)&&(s=e,a=t)}))})),a){const e=Math.max(s.character.attack-a.character.defence,.1*s.character.attack);this.gamePlay.showDamage(a.position,e).then((()=>{a.character.health-=e,a.character.health<=0&&(this.getDeletion(a.position),this.userTeam.delete(a.character),this.gamePlay.deselectCell(this.gameState.selected),this.gameState.selected=null)})).then((()=>{this.gamePlay.redrawPositions(this.gameState.allPositions),this.gameState.isUsersTurn=!0})).then((()=>{this.getGameResult()}))}else{s=e[Math.floor(Math.random()*e.length)];const t=this.calcRange(s.position,s.character.distance);t.forEach((e=>{this.gameState.allPositions.forEach((s=>{e===s.position&&t.splice(t.indexOf(s.position),1)}))}));const a=this.getRandom(t);s.position=a,this.gamePlay.redrawPositions(this.gameState.allPositions),this.gameState.isUsersTurn=!0}}getGameResult(){0===this.userTeam.members.size&&(this.gameState.statistics.push(this.gameState.points),e.showMessage(`–í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏...–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –æ—á–∫–æ–≤: ${this.gameState.points}`)),0===this.botTeam.members.size&&4===this.gameState.level&&(this.scoringPoints(),this.gameState.statistics.push(this.gameState.points),e.showMessage(`–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–±–µ–¥–∏–ª–∏! –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –æ—á–∫–æ–≤: ${this.gameState.points},\n      –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—á–∫–æ–≤: ${Math.max(...this.gameState.statistics)}`),this.gameState.level+=1),0===this.botTeam.members.size&&this.gameState.level<=3&&(this.gameState.isUsersTurn=!0,this.scoringPoints(),e.showMessage(`–í—ã –ø—Ä–æ—à–ª–∏ —É—Ä–æ–≤–µ–Ω—å ${this.gameState.level} –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –æ—á–∫–æ–≤: ${this.gameState.points}`),this.gameState.level+=1,this.getLevelUp())}getLevelUp(){this.gameState.allPositions=[],this.userTeam.members.forEach((e=>e.levelUp())),2===this.gameState.level&&(this.userTeam.addAll(a(this.userCharacters,1,1)),this.botTeam.addAll(a(this.botCharacters,2,this.userTeam.members.size))),3===this.gameState.level&&(this.userTeam.addAll(a(this.userCharacters,2,2)),this.botTeam.addAll(a(this.botCharacters,3,this.userTeam.members.size))),4===this.gameState.level&&(this.userTeam.addAll(a(this.userCharacters,3,2)),this.botTeam.addAll(a(this.botCharacters,4,this.userTeam.members.size))),e.showMessage(`–£—Ä–æ–≤–µ–Ω—å ${this.gameState.level}`),this.gamePlay.drawUi(t[this.gameState.level]),this.addsTheTeamToPosition(this.userTeam,this.getUserStartPositions()),this.addsTheTeamToPosition(this.botTeam,this.getBotStartPositions()),this.gamePlay.redrawPositions(this.gameState.allPositions)}scoringPoints(){this.gameState.points+=this.userTeam.toArray().reduce(((e,t)=>e+t.health),0)}getDeletion(e){const t=this.gameState.allPositions;t.splice(t.indexOf(this.getChar(e)),1)}isMoving(e){if(this.getSelectedChar()){const t=this.getSelectedChar().character.distance;return this.calcRange(this.gameState.selected,t).includes(e)}return!1}isAttack(e){if(this.getSelectedChar()){const t=this.getSelectedChar().character.attackRange;return this.calcRange(this.gameState.selected,t).includes(e)}return!1}getSelectedChar(){return this.gameState.allPositions.find((e=>e.position===this.gameState.selected))}getUserStartPositions(){const e=this.gamePlay.boardSize;this.userPosition=[];for(let t=0,s=1;this.userPosition.length<2*e;t+=e,s+=e)this.userPosition.push(t,s);return this.userPosition}getBotStartPositions(){const e=this.gamePlay.boardSize,t=[];for(let s=e-2,a=e-1;t.length<2*e;s+=e,a+=e)t.push(s,a);return t}getRandom(e){return this.positions=e,this.positions[Math.floor(Math.random()*this.positions.length)]}addsTheTeamToPosition(e,t){const s=[...t];for(const t of e){const e=this.getRandom(s);this.gameState.allPositions.push(new d(t,e)),s.splice(s.indexOf(e),1)}}isUserChar(e){if(this.getChar(e)){const t=this.getChar(e).character;return this.userCharacters.some((e=>t instanceof e))}return!1}isBotChar(e){if(this.getChar(e)){const t=this.getChar(e).character;return this.botCharacters.some((e=>t instanceof e))}return!1}getChar(e){return this.gameState.allPositions.find((t=>t.position===e))}calcRange(e,t){const s=this.gamePlay.boardSize,a=[],i=[],h=[];for(let e=0,t=s-1;i.length<s;e+=s,t+=s)i.push(e),h.push(t);for(let i=1;i<=t;i+=1)a.push(e+s*i),a.push(e-s*i);for(let h=1;h<=t&&!i.includes(e)&&(a.push(e-h),a.push(e-(s*h+h)),a.push(e+(s*h-h)),!i.includes(e-h));h+=1);for(let i=1;i<=t&&!h.includes(e)&&(a.push(e+i),a.push(e-(s*i-i)),a.push(e+(s*i+i)),!h.includes(e+i));i+=1);return a.filter((e=>e>=0&&e<=s**2-1))}onNewGameClick(){this.userTeam=new s,this.botTeam=new s,this.botCharacters=[l,n,o],this.userCharacters=[h,r,c],this.gameState.selected=null,this.gameState.level=1,this.gameState.points=0,this.gameState.allPositions=[],this.gameState.isUsersTurn=!0,this.gamePlay.drawUi(t[this.gameState.level]),this.userTeam.addAll(a([h,r],1,2)),this.botTeam.addAll(a(this.botCharacters,1,2)),this.addsTheTeamToPosition(this.userTeam,this.getUserStartPositions()),this.addsTheTeamToPosition(this.botTeam,this.getBotStartPositions()),this.gamePlay.redrawPositions(this.gameState.allPositions),e.showMessage(`–£—Ä–æ–≤–µ–Ω—å ${this.gameState.level}`)}onSaveGameClick(){this.stateService.save(m.from(this.gameState)),e.showMessage("–ò–≥—Ä–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")}onLoadGameClick(){e.showMessage("–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è");const a=this.stateService.load();a||e.showError("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏"),this.gameState.isUsersTurn=a.isUsersTurn,this.gameState.level=a.level,this.gameState.allPositions=[],this.gameState.points=a.points,this.gameState.statistics=a.statistics,this.gameState.selected=a.selected,this.userTeam=new s,this.botTeam=new s,a.allPositions.forEach((e=>{let t;switch(e.character.type){case"swordsman":t=new r(e.character.level),this.userTeam.addAll([t]);break;case"bowman":t=new h(e.character.level),this.userTeam.addAll([t]);break;case"magician":t=new c(e.character.level),this.userTeam.addAll([t]);break;case"undead":t=new n(e.character.level),this.botTeam.addAll([t]);break;case"vampire":t=new o(e.character.level),this.botTeam.addAll([t]);break;case"daemon":t=new l(e.character.level),this.botTeam.addAll([t])}t.health=e.character.health,this.gameState.allPositions.push(new d(t,e.position))})),this.gamePlay.drawUi(t[this.gameState.level]),this.gamePlay.redrawPositions(this.gameState.allPositions)}}(v,C);p.init()}();